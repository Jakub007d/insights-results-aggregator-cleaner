<!DOCTYPE html>
<html>
<head>
<title>storage_test.go</title>
<meta charset="utf-8"/>
<style type="text/css">body {
    background: rgb(225, 225, 225);
    margin: 0px;
    padding: 0px;
}

#docgo p {
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 15px;
    margin-left: 0px;
}

#docgo div {
    display: inline;
}

#docgo #background {
    position: fixed;
    top: 0; left: 525px; right: 0; bottom: 0;
    background: rgb(47, 47, 47);
    border-left: 1px solid #e5e5ee;
    z-index: -1;
}

#docgo .keyword {
    color: rgb(250, 200, 100);
}

#docgo .literal {
    color: rgb(140, 190, 100);
}

#docgo .ident {
    color: white;
}

#docgo .operator {
    color: white;
}

#docgo .comment {
}

#docgo h1, h2, h3, h4, h5 {
    text-align: left;
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 15px;
    margin-left: 0px;
}

#docgo h1 {
    margin-top: 40px;
}

#docgo .doc {
    vertical-align: top;
    font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
    font-size: 15px;
    line-height: 22px;
    color: black;
    min-width: 450px;
    max-width: 450px;
    padding-top: 10px;
    padding-right: 25px;
    padding-bottom: 1px;
    padding-left: 50px;
    overflow-x: hidden;
}

#docgo .code {
    min-width: 650px;
    max-width: 650px;
    padding-left: 25px;
    padding-right: 15px;
    border-left: 1px;
    overflow-x: hidden;
    vertical-align: top;
}

#docgo .code pre code  {
    font-size: 12px;
    line-height: 18px;
    font-family: Menlo, Monaco, Consolas, "Lucida Console", monospace;
    color: rgb(120, 120, 120);
}
</style>
</head>
<body>
<div id="docgo">
  <div id="background"></div>
  <table>
    <thead><tr><th class="doc"><h1>storage_test.go</h1></th><th class="code"></th></tr></thead>
    <tbody>
      
      <tr class="section">
	<td class="doc"></td>
	<td class="code"><pre><code><div class="comment">/*
Copyright Â© 2021, 2022, 2023 Red Hat, Inc.

Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/</div>

<div class="keyword">package</div> <div class="ident">main_test</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Documentation in literate-programming-style is available at:
https://redhatinsights.github.io/insights-results-aggregator-cleaner/packages/database_test.html</p>
</td>
	<td class="code"><pre><code>
<div class="keyword">import</div> <div class="operator">(</div>
	<div class="literal">&#34;bufio&#34;</div><div class="operator"></div>
	<div class="literal">&#34;database/sql&#34;</div><div class="operator"></div>
	<div class="literal">&#34;errors&#34;</div><div class="operator"></div>
	<div class="literal">&#34;fmt&#34;</div><div class="operator"></div>
	<div class="literal">&#34;os&#34;</div><div class="operator"></div>
	<div class="literal">&#34;strings&#34;</div><div class="operator"></div>
	<div class="literal">&#34;testing&#34;</div><div class="operator"></div>
	<div class="literal">&#34;time&#34;</div><div class="operator"></div>

	<div class="literal">&#34;github.com/DATA-DOG/go-sqlmock&#34;</div><div class="operator"></div>
	<div class="ident">cleaner</div> <div class="literal">&#34;github.com/RedHatInsights/insights-results-aggregator-cleaner&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/stretchr/testify/assert&#34;</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

<div class="keyword">const</div> <div class="operator">(</div>
	<div class="ident">cluster1ID</div>   <div class="operator">=</div> <div class="literal">&#34;123e4567-e89b-12d3-a456-426614173998&#34;</div><div class="operator"></div>
	<div class="ident">cluster2ID</div>   <div class="operator">=</div> <div class="literal">&#34;567e4567-4321-12d3-a456-426614173777&#34;</div><div class="operator"></div>
	<div class="ident">rule1ID</div>      <div class="operator">=</div> <div class="literal">&#34;rule.test|KEY&#34;</div><div class="operator"></div>
	<div class="ident">defaultOrgID</div> <div class="operator">=</div> <div class="literal">42</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>checkConnectionClose function performs mocked DB closing operation and checks
if the connection is properly closed from unit tests.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">checkConnectionClose</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">,</div> <div class="ident">connection</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>connection to mocked DB needs to be closed properly</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">connection</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>checkAllExpectations function checks if all database-related operations have
been really met.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">checkAllExpectations</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">,</div> <div class="ident">mock</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">Sqlmock</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if all expectations were met</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectationsWereMet</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expectOrgIDQuery mocks an expect of a repetetive query to check whether cluster
belongs to given org</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">expectOrgIDQuery</div><div class="operator">(</div><div class="ident">mock</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">Sqlmock</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare mocked result for SQL query</p>
</td>
	<td class="code"><pre><code>	<div class="ident">rows</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewRows</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div><div class="literal">&#34;org_id&#34;</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">rows</div><div class="operator">.</div><div class="ident">AddRow</div><div class="operator">(</div><div class="ident">defaultOrgID</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expected query performed by tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">expectedQuery</div> <div class="operator">:=</div> <div class="literal">&#34;select org_id from report where cluster = \\$1&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="ident">expectedQuery</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnRows</div><div class="operator">(</div><div class="ident">rows</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expectOrgIDQueryError mocks an expect of a repetetive query to check whether cluster
belongs to given org</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">expectOrgIDQueryError</div><div class="operator">(</div><div class="ident">mock</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">Sqlmock</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>error to be thrown</p>
</td>
	<td class="code"><pre><code>	<div class="ident">mockedError</div> <div class="operator">:=</div> <div class="ident">errors</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="literal">&#34;read org ID error&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expected query performed by tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">expectedQuery</div> <div class="operator">:=</div> <div class="literal">&#34;select org_id from report where cluster = \\$1&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="ident">expectedQuery</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnError</div><div class="operator">(</div><div class="ident">mockedError</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestReadOrgIDNoResults checks the function readOrgID.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestReadOrgIDNoResults</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare new mocked connection to database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error creating SQL mock&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare mocked result for SQL query</p>
</td>
	<td class="code"><pre><code>	<div class="ident">rows</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewRows</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expected query performed by tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">expectedQuery</div> <div class="operator">:=</div> <div class="literal">&#34;select org_id from report where cluster = \\$1&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="ident">expectedQuery</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnRows</div><div class="operator">(</div><div class="ident">rows</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectClose</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>call the tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">org_id</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">ReadOrgID</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="literal">&#34;123e4567-e89b-12d3-a456-426614174000&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error not expected while calling tested function&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check the org ID returned from tested function</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="ident">org_id</div> <div class="operator">!=</div> <div class="operator">-</div><div class="literal">1</div> <div class="operator">{</div>
		<div class="ident">t</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="literal">&#34;wrong org_id returned: %d&#34;</div><div class="operator">,</div> <div class="ident">org_id</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if DB can be closed successfully</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkConnectionClose</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">connection</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check all DB expectactions happened correctly</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkAllExpectations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestReadOrgIDResults checks the function readOrgID.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestReadOrgIDResult</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare new mocked connection to database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error creating SQL mock&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare mocked result for SQL query</p>
</td>
	<td class="code"><pre><code>	<div class="ident">expectOrgIDQuery</div><div class="operator">(</div><div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>call the tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">org_id</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">ReadOrgID</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="literal">&#34;123e4567-e89b-12d3-a456-426614174000&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error not expected while calling tested function&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check the org ID returned from tested function</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="ident">org_id</div> <div class="operator">!=</div> <div class="ident">defaultOrgID</div> <div class="operator">{</div>
		<div class="ident">t</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="literal">&#34;wrong org_id returned: %d&#34;</div><div class="operator">,</div> <div class="ident">org_id</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if DB can be closed successfully</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkConnectionClose</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">connection</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check all DB expectactions happened correctly</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkAllExpectations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestReadOrgIDOnError checks error handling in function readOrgID.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestReadOrgIDOnError</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>error to be thrown</p>
</td>
	<td class="code"><pre><code>	<div class="ident">mockedError</div> <div class="operator">:=</div> <div class="ident">errors</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="literal">&#34;mocked error&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare new mocked connection to database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error creating SQL mock&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expected query performed by tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">expectedQuery</div> <div class="operator">:=</div> <div class="literal">&#34;select org_id from report where cluster = \\$1&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="ident">expectedQuery</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnError</div><div class="operator">(</div><div class="ident">mockedError</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectClose</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>call the tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">org_id</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">ReadOrgID</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="literal">&#34;123e4567-e89b-12d3-a456-426614173999&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">==</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">t</div><div class="operator">.</div><div class="ident">Fatalf</div><div class="operator">(</div><div class="literal">&#34;error was expected while updating stats&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check the org ID returned from tested function</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="ident">org_id</div> <div class="operator">!=</div> <div class="operator">-</div><div class="literal">1</div> <div class="operator">{</div>
		<div class="ident">t</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="literal">&#34;wrong org_id returned: %d&#34;</div><div class="operator">,</div> <div class="ident">org_id</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if the error is correct</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">mockedError</div> <div class="operator">{</div>
		<div class="ident">t</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="literal">&#34;different error was returned: %v&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if DB can be closed successfully</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkConnectionClose</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">connection</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check all DB expectactions happened correctly</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkAllExpectations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestReadOrgIDScanError checks error handling in function readOrgID.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestReadOrgIDScanError</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare new mocked connection to database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error creating SQL mock&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare mocked result for SQL query</p>
</td>
	<td class="code"><pre><code>	<div class="ident">rows</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewRows</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div><div class="literal">&#34;org_id&#34;</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">rows</div><div class="operator">.</div><div class="ident">AddRow</div><div class="operator">(</div><div class="ident">nil</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expected query performed by tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">expectedQuery</div> <div class="operator">:=</div> <div class="literal">&#34;select org_id from report where cluster = \\$1&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="ident">expectedQuery</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnRows</div><div class="operator">(</div><div class="ident">rows</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectClose</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>call the tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">org_id</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">ReadOrgID</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="literal">&#34;123e4567-e89b-12d3-a456-426614173999&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;scan error is expected&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check the org ID returned from tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="operator">-</div><div class="literal">1</div><div class="operator">,</div> <div class="ident">org_id</div><div class="operator">,</div> <div class="literal">&#34;wrong org_id returned: %d&#34;</div><div class="operator">,</div> <div class="ident">org_id</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if DB can be closed successfully</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkConnectionClose</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">connection</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check all DB expectactions happened correctly</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkAllExpectations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestPerformDisplayMultipleRuleDisableNoResults checks the basic behaviour of
performDisplayMultipleRuleDisable function.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestPerformDisplayMultipleRuleDisableNoResults</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare new mocked connection to database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error creating SQL mock&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare mocked result for SQL query</p>
</td>
	<td class="code"><pre><code>	<div class="ident">rows</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewRows</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expected query performed by tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">expectedQuery</div> <div class="operator">:=</div> <div class="literal">&#34;select cluster_id, rule_id, count\\(\\*\\) as cnt from cluster_rule_toggle group by cluster_id, rule_id having count\\(\\*\\)&gt;1 order by cnt desc;&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="ident">expectedQuery</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnRows</div><div class="operator">(</div><div class="ident">rows</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectClose</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>first query to be performed</p>
</td>
	<td class="code"><pre><code>	<div class="ident">query1</div> <div class="operator">:=</div> <div class="literal">`
                select cluster_id, rule_id, count(*) as cnt
                  from cluster_rule_toggle
                 group by cluster_id, rule_id
                having count(*)&gt;1
                 order by cnt desc;
`</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>call the tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">PerformDisplayMultipleRuleDisable</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">query1</div><div class="operator">,</div> <div class="literal">&#34;cluster_rule_toggle&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error not expected while calling tested function&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if DB can be closed successfully</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkConnectionClose</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">connection</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check all DB expectactions happened correctly</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkAllExpectations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestPerformDisplayMultipleRuleDisableOnError checks the error handling
ability in performDisplayMultipleRuleDisable function.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestPerformDisplayMultipleRuleDisableOnError</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>error to be thrown</p>
</td>
	<td class="code"><pre><code>	<div class="ident">mockedError</div> <div class="operator">:=</div> <div class="ident">errors</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="literal">&#34;mocked error&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare new mocked connection to database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error creating SQL mock&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expected query performed by tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">expectedQuery</div> <div class="operator">:=</div> <div class="literal">&#34;select cluster_id, rule_id, count\\(\\*\\) as cnt from cluster_rule_toggle group by cluster_id, rule_id having count\\(\\*\\)&gt;1 order by cnt desc;&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="ident">expectedQuery</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnError</div><div class="operator">(</div><div class="ident">mockedError</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectClose</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>first query to be performed</p>
</td>
	<td class="code"><pre><code>	<div class="ident">query1</div> <div class="operator">:=</div> <div class="literal">`
                select cluster_id, rule_id, count(*) as cnt
                  from cluster_rule_toggle
                 group by cluster_id, rule_id
                having count(*)&gt;1
                 order by cnt desc;
`</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>call the tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">PerformDisplayMultipleRuleDisable</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">query1</div><div class="operator">,</div> <div class="literal">&#34;cluster_rule_toggle&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">==</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">t</div><div class="operator">.</div><div class="ident">Fatalf</div><div class="operator">(</div><div class="literal">&#34;error was expected while updating stats&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if the error is correct</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">mockedError</div> <div class="operator">{</div>
		<div class="ident">t</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="literal">&#34;different error was returned: %v&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if DB can be closed successfully</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkConnectionClose</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">connection</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check all DB expectactions happened correctly</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkAllExpectations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestPerformDisplayMultipleRuleDisableOnScanError checks the error handling
ability in performDisplayMultipleRuleDisable function regarding wrong values returned from query.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestPerformDisplayMultipleRuleDisableOnScanError</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare new mocked connection to database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error creating SQL mock&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare mocked result for SQL query</p>
</td>
	<td class="code"><pre><code>	<div class="ident">rows1</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewRows</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div><div class="literal">&#34;cluster_id&#34;</div><div class="operator">,</div> <div class="literal">&#34;rule_id&#34;</div><div class="operator">,</div> <div class="literal">&#34;cnt&#34;</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">rows1</div><div class="operator">.</div><div class="ident">AddRow</div><div class="operator">(</div><div class="ident">nil</div><div class="operator">,</div> <div class="ident">rule1ID</div><div class="operator">,</div> <div class="literal">1</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expected query performed by tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">expectedQuery1</div> <div class="operator">:=</div> <div class="literal">&#34;select cluster_id, rule_id, count\\(\\*\\) as cnt from cluster_rule_toggle group by cluster_id, rule_id having count\\(\\*\\)&gt;1 order by cnt desc;&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="ident">expectedQuery1</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnRows</div><div class="operator">(</div><div class="ident">rows1</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>org_id query is not expected, as the first query should fail</p>
</td>
	<td class="code"><pre><code>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectClose</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>first query to be performed</p>
</td>
	<td class="code"><pre><code>	<div class="ident">query1</div> <div class="operator">:=</div> <div class="literal">`
                select cluster_id, rule_id, count(*) as cnt
                  from cluster_rule_toggle
                 group by cluster_id, rule_id
                having count(*)&gt;1
                 order by cnt desc;
`</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>call the tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">PerformDisplayMultipleRuleDisable</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">query1</div><div class="operator">,</div> <div class="literal">&#34;cluster_rule_toggle&#34;</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>must throw error</p>
</td>
	<td class="code"><pre><code>	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if DB can be closed successfully</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkConnectionClose</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">connection</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check all DB expectactions happened correctly</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkAllExpectations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestPerformDisplayMultipleRuleDisableResults checks the basic behaviour of
performDisplayMultipleRuleDisable function with results returned. Contents
of generated file(s) is checked in displayMultipleRuleDisableResulsts test cases</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestPerformDisplayMultipleRuleDisableResults</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare new mocked connection to database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error creating SQL mock&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare mocked result for SQL query</p>
</td>
	<td class="code"><pre><code>	<div class="ident">rows1</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewRows</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div><div class="literal">&#34;cluster_id&#34;</div><div class="operator">,</div> <div class="literal">&#34;rule_id&#34;</div><div class="operator">,</div> <div class="literal">&#34;cnt&#34;</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">rows1</div><div class="operator">.</div><div class="ident">AddRow</div><div class="operator">(</div><div class="ident">cluster1ID</div><div class="operator">,</div> <div class="ident">rule1ID</div><div class="operator">,</div> <div class="literal">1</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expected query performed by tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">expectedQuery1</div> <div class="operator">:=</div> <div class="literal">&#34;select cluster_id, rule_id, count\\(\\*\\) as cnt from cluster_rule_toggle group by cluster_id, rule_id having count\\(\\*\\)&gt;1 order by cnt desc;&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="ident">expectedQuery1</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnRows</div><div class="operator">(</div><div class="ident">rows1</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare mocked result for SQL query</p>
</td>
	<td class="code"><pre><code>	<div class="ident">expectOrgIDQuery</div><div class="operator">(</div><div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectClose</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>first query to be performed</p>
</td>
	<td class="code"><pre><code>	<div class="ident">query1</div> <div class="operator">:=</div> <div class="literal">`
                select cluster_id, rule_id, count(*) as cnt
                  from cluster_rule_toggle
                 group by cluster_id, rule_id
                having count(*)&gt;1
                 order by cnt desc;
`</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>call the tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">PerformDisplayMultipleRuleDisable</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">query1</div><div class="operator">,</div> <div class="literal">&#34;cluster_rule_toggle&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error not expected while calling tested function&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if DB can be closed successfully</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkConnectionClose</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">connection</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check all DB expectactions happened correctly</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkAllExpectations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestDisplayMultipleRuleDisableResultsScanError checks the basic behaviour of
displayMultipleRuleDisable function with results returned without defining the filenames.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestDisplayMultipleRuleDisableResultsScanError</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare new mocked connection to database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error creating SQL mock&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare mocked result for SQL query</p>
</td>
	<td class="code"><pre><code>	<div class="ident">toggleRows</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewRows</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div><div class="literal">&#34;cluster_id&#34;</div><div class="operator">,</div> <div class="literal">&#34;rule_id&#34;</div><div class="operator">,</div> <div class="literal">&#34;cnt&#34;</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">toggleRows</div><div class="operator">.</div><div class="ident">AddRow</div><div class="operator">(</div><div class="ident">nil</div><div class="operator">,</div> <div class="ident">rule1ID</div><div class="operator">,</div> <div class="literal">1</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expected query performed by tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">toggleQuery</div> <div class="operator">:=</div> <div class="literal">&#34;select cluster_id, rule_id, count\\(\\*\\) as cnt from cluster_rule_toggle group by cluster_id, rule_id having count\\(\\*\\)&gt;1 order by cnt desc;&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="ident">toggleQuery</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnRows</div><div class="operator">(</div><div class="ident">toggleRows</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>another org_id query</p>
</td>
	<td class="code"><pre><code>	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectClose</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>call the tested function without filename (only printed in logs)</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">DisplayMultipleRuleDisable</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="literal">&#34;&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if DB can be closed successfully</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkConnectionClose</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">connection</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check all DB expectactions happened correctly</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkAllExpectations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestDisplayMultipleRuleDisableOnError checks the error handling
ability in displayMultipleRuleDisable function.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestDisplayMultipleRuleDisableOnError</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>error to be thrown</p>
</td>
	<td class="code"><pre><code>	<div class="ident">mockedError</div> <div class="operator">:=</div> <div class="ident">errors</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="literal">&#34;mocked error&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare new mocked connection to database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error creating SQL mock&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expected query performed by tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">toggleQuery</div> <div class="operator">:=</div> <div class="literal">&#34;select cluster_id, rule_id, count\\(\\*\\) as cnt from cluster_rule_toggle group by cluster_id, rule_id having count\\(\\*\\)&gt;1 order by cnt desc;&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="ident">toggleQuery</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnError</div><div class="operator">(</div><div class="ident">mockedError</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>org_id query is not expected because first query should fail</p>
</td>
	<td class="code"><pre><code>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectClose</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>call the tested function without filename (only printed in logs)</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">DisplayMultipleRuleDisable</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="literal">&#34;&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if the error is correct</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">mockedError</div> <div class="operator">{</div>
		<div class="ident">t</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="literal">&#34;different error was returned: %v&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if DB can be closed successfully</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkConnectionClose</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">connection</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check all DB expectactions happened correctly</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkAllExpectations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestPerformDisplayMultipleRuleDisableScanError2 checks the basic behaviour of
performDisplayMultipleRuleDisable function with wrong records returned from database.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestPerformDisplayMultipleRuleDisableScanError2</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare new mocked connection to database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error creating SQL mock&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare mocked result for SQL query</p>
</td>
	<td class="code"><pre><code>	<div class="ident">rows1</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewRows</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div><div class="literal">&#34;cluster_id&#34;</div><div class="operator">,</div> <div class="literal">&#34;rule_id&#34;</div><div class="operator">,</div> <div class="literal">&#34;cnt&#34;</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">rows1</div><div class="operator">.</div><div class="ident">AddRow</div><div class="operator">(</div><div class="ident">cluster1ID</div><div class="operator">,</div> <div class="ident">rule1ID</div><div class="operator">,</div> <div class="literal">1</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expected query performed by tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">expectedQuery1</div> <div class="operator">:=</div> <div class="literal">&#34;select cluster_id, rule_id, count\\(\\*\\) as cnt from cluster_rule_toggle group by cluster_id, rule_id having count\\(\\*\\)&gt;1 order by cnt desc;&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="ident">expectedQuery1</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnRows</div><div class="operator">(</div><div class="ident">rows1</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare mocked result for SQL query</p>
</td>
	<td class="code"><pre><code>	<div class="ident">expectOrgIDQueryError</div><div class="operator">(</div><div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectClose</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>first query to be performed</p>
</td>
	<td class="code"><pre><code>	<div class="ident">query1</div> <div class="operator">:=</div> <div class="literal">`
                select cluster_id, rule_id, count(*) as cnt
                  from cluster_rule_toggle
                 group by cluster_id, rule_id
                having count(*)&gt;1
                 order by cnt desc;
`</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>call the tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">PerformDisplayMultipleRuleDisable</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">query1</div><div class="operator">,</div> <div class="literal">&#34;cluster_rule_toggle&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error is expected while calling tested function&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if DB can be closed successfully</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkConnectionClose</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">connection</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check all DB expectactions happened correctly</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkAllExpectations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestDisplayMultipleRuleDisableResultsNoOutput checks the basic behaviour of
displayMultipleRuleDisable function with results returned without defining the filenames.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestDisplayMultipleRuleDisableResultsNoOutput</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare new mocked connection to database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error creating SQL mock&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare mocked result for SQL query</p>
</td>
	<td class="code"><pre><code>	<div class="ident">toggleRows</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewRows</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div><div class="literal">&#34;cluster_id&#34;</div><div class="operator">,</div> <div class="literal">&#34;rule_id&#34;</div><div class="operator">,</div> <div class="literal">&#34;cnt&#34;</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">toggleRows</div><div class="operator">.</div><div class="ident">AddRow</div><div class="operator">(</div><div class="ident">cluster1ID</div><div class="operator">,</div> <div class="ident">rule1ID</div><div class="operator">,</div> <div class="literal">1</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expected query performed by tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">toggleQuery</div> <div class="operator">:=</div> <div class="literal">&#34;select cluster_id, rule_id, count\\(\\*\\) as cnt from cluster_rule_toggle group by cluster_id, rule_id having count\\(\\*\\)&gt;1 order by cnt desc;&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="ident">toggleQuery</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnRows</div><div class="operator">(</div><div class="ident">toggleRows</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare mocked org_id query result for SQL query</p>
</td>
	<td class="code"><pre><code>	<div class="ident">expectOrgIDQuery</div><div class="operator">(</div><div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare mocked result for SQL query</p>
</td>
	<td class="code"><pre><code>	<div class="ident">feedbackRows</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewRows</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div><div class="literal">&#34;cluster_id&#34;</div><div class="operator">,</div> <div class="literal">&#34;rule_id&#34;</div><div class="operator">,</div> <div class="literal">&#34;cnt&#34;</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">feedbackRows</div><div class="operator">.</div><div class="ident">AddRow</div><div class="operator">(</div><div class="ident">cluster2ID</div><div class="operator">,</div> <div class="ident">rule1ID</div><div class="operator">,</div> <div class="literal">1</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expected query performed by tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">feedbackQuery</div> <div class="operator">:=</div> <div class="literal">&#34;select cluster_id, rule_id, count\\(\\*\\) as cnt from cluster_user_rule_disable_feedback group by cluster_id, rule_id having count\\(\\*\\)&gt;1 order by cnt desc;&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="ident">feedbackQuery</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnRows</div><div class="operator">(</div><div class="ident">feedbackRows</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare mocked org_id query result for SQL query</p>
</td>
	<td class="code"><pre><code>	<div class="ident">expectOrgIDQuery</div><div class="operator">(</div><div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>another org_id query</p>
</td>
	<td class="code"><pre><code>	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectClose</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>call the tested function without filename (only printed in logs)</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">DisplayMultipleRuleDisable</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="literal">&#34;&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error not expected while calling tested function&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if DB can be closed successfully</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkConnectionClose</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">connection</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check all DB expectactions happened correctly</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkAllExpectations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestDisplayMultipleRuleDisableResultsFileOutput checks the basic behaviour of
displayMultipleRuleDisable function with results returned and checks whether
the files were generated correctly.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestDisplayMultipleRuleDisableResultsFileOutput</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">const</div> <div class="ident">outFile</div> <div class="operator">=</div> <div class="literal">&#34;testdisable.out&#34;</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare new mocked connection to database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error creating SQL mock&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare mocked result for SQL query</p>
</td>
	<td class="code"><pre><code>	<div class="ident">toggleRows</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewRows</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div><div class="literal">&#34;cluster_id&#34;</div><div class="operator">,</div> <div class="literal">&#34;rule_id&#34;</div><div class="operator">,</div> <div class="literal">&#34;cnt&#34;</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">toggleRows</div><div class="operator">.</div><div class="ident">AddRow</div><div class="operator">(</div><div class="ident">cluster1ID</div><div class="operator">,</div> <div class="ident">rule1ID</div><div class="operator">,</div> <div class="literal">1</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expected query performed by tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">toggleQuery</div> <div class="operator">:=</div> <div class="literal">&#34;select cluster_id, rule_id, count\\(\\*\\) as cnt from cluster_rule_toggle group by cluster_id, rule_id having count\\(\\*\\)&gt;1 order by cnt desc;&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="ident">toggleQuery</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnRows</div><div class="operator">(</div><div class="ident">toggleRows</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare mocked org_id query result for SQL query</p>
</td>
	<td class="code"><pre><code>	<div class="ident">expectOrgIDQuery</div><div class="operator">(</div><div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare mocked result for SQL query</p>
</td>
	<td class="code"><pre><code>	<div class="ident">feedbackRows</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewRows</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div><div class="literal">&#34;cluster_id&#34;</div><div class="operator">,</div> <div class="literal">&#34;rule_id&#34;</div><div class="operator">,</div> <div class="literal">&#34;cnt&#34;</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">feedbackRows</div><div class="operator">.</div><div class="ident">AddRow</div><div class="operator">(</div><div class="ident">cluster2ID</div><div class="operator">,</div> <div class="ident">rule1ID</div><div class="operator">,</div> <div class="literal">1</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expected query performed by tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">feedbackQuery</div> <div class="operator">:=</div> <div class="literal">&#34;select cluster_id, rule_id, count\\(\\*\\) as cnt from cluster_user_rule_disable_feedback group by cluster_id, rule_id having count\\(\\*\\)&gt;1 order by cnt desc;&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="ident">feedbackQuery</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnRows</div><div class="operator">(</div><div class="ident">feedbackRows</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare mocked org_id query result for SQL query</p>
</td>
	<td class="code"><pre><code>	<div class="ident">expectOrgIDQuery</div><div class="operator">(</div><div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>another org_id query</p>
</td>
	<td class="code"><pre><code>	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectClose</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>call the tested function with filename</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">DisplayMultipleRuleDisable</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="ident">outFile</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error not expected while calling tested function&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if DB can be closed successfully</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkConnectionClose</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">connection</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check all DB expectactions happened correctly</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkAllExpectations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check contents of the output file</p>
</td>
	<td class="code"><pre><code>	<div class="ident">outputFile</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">os</div><div class="operator">.</div><div class="ident">Open</div><div class="operator">(</div><div class="ident">outFile</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">scanner</div> <div class="operator">:=</div> <div class="ident">bufio</div><div class="operator">.</div><div class="ident">NewScanner</div><div class="operator">(</div><div class="ident">outputFile</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">var</div> <div class="ident">lines</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator"></div>
	<div class="keyword">for</div> <div class="ident">scanner</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="ident">lines</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">lines</div><div class="operator">,</div> <div class="ident">scanner</div><div class="operator">.</div><div class="ident">Text</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>two lines must be in the file</p>
</td>
	<td class="code"><pre><code>	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Len</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">lines</div><div class="operator">,</div> <div class="literal">2</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>4 comma separated values</p>
</td>
	<td class="code"><pre><code>	<div class="ident">ruleToggleLine</div> <div class="operator">:=</div> <div class="ident">strings</div><div class="operator">.</div><div class="ident">Split</div><div class="operator">(</div><div class="ident">lines</div><div class="operator">[</div><div class="literal">0</div><div class="operator">]</div><div class="operator">,</div> <div class="literal">&#34;,&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Len</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">ruleToggleLine</div><div class="operator">,</div> <div class="literal">4</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check elements in csv</p>
</td>
	<td class="code"><pre><code>	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">ruleToggleLine</div><div class="operator">[</div><div class="literal">0</div><div class="operator">]</div><div class="operator">,</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Sprint</div><div class="operator">(</div><div class="ident">defaultOrgID</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">ruleToggleLine</div><div class="operator">[</div><div class="literal">1</div><div class="operator">]</div><div class="operator">,</div> <div class="ident">cluster1ID</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">ruleToggleLine</div><div class="operator">[</div><div class="literal">2</div><div class="operator">]</div><div class="operator">,</div> <div class="ident">rule1ID</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">ruleToggleLine</div><div class="operator">[</div><div class="literal">3</div><div class="operator">]</div><div class="operator">,</div> <div class="literal">&#34;1&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">ruleFeedbackLine</div> <div class="operator">:=</div> <div class="ident">strings</div><div class="operator">.</div><div class="ident">Split</div><div class="operator">(</div><div class="ident">lines</div><div class="operator">[</div><div class="literal">1</div><div class="operator">]</div><div class="operator">,</div> <div class="literal">&#34;,&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">ruleFeedbackLine</div><div class="operator">[</div><div class="literal">0</div><div class="operator">]</div><div class="operator">,</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Sprint</div><div class="operator">(</div><div class="ident">defaultOrgID</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">ruleFeedbackLine</div><div class="operator">[</div><div class="literal">1</div><div class="operator">]</div><div class="operator">,</div> <div class="ident">cluster2ID</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">ruleFeedbackLine</div><div class="operator">[</div><div class="literal">2</div><div class="operator">]</div><div class="operator">,</div> <div class="ident">rule1ID</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">ruleFeedbackLine</div><div class="operator">[</div><div class="literal">3</div><div class="operator">]</div><div class="operator">,</div> <div class="literal">&#34;1&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">outputFile</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>delete test file from filesystem</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">os</div><div class="operator">.</div><div class="ident">Remove</div><div class="operator">(</div><div class="ident">outFile</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestDisplayMultipleRuleDisableResultsFileError checks the basic behaviour of
displayMultipleRuleDisable function with results returned and an invalid filename</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestDisplayMultipleRuleDisableResultsFileError</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare new mocked connection to database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error creating SQL mock&#34;</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare mocked result for SQL query</p>
</td>
	<td class="code"><pre><code>	<div class="ident">toggleRows</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewRows</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div><div class="literal">&#34;cluster_id&#34;</div><div class="operator">,</div> <div class="literal">&#34;rule_id&#34;</div><div class="operator">,</div> <div class="literal">&#34;cnt&#34;</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">toggleRows</div><div class="operator">.</div><div class="ident">AddRow</div><div class="operator">(</div><div class="ident">cluster1ID</div><div class="operator">,</div> <div class="ident">rule1ID</div><div class="operator">,</div> <div class="literal">1</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expected query performed by tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">toggleQuery</div> <div class="operator">:=</div> <div class="literal">&#34;select cluster_id, rule_id, count\\(\\*\\) as cnt from cluster_rule_toggle group by cluster_id, rule_id having count\\(\\*\\)&gt;1 order by cnt desc;&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="ident">toggleQuery</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnRows</div><div class="operator">(</div><div class="ident">toggleRows</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare mocked org_id query result for SQL query</p>
</td>
	<td class="code"><pre><code>	<div class="ident">expectOrgIDQuery</div><div class="operator">(</div><div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare mocked result for SQL query</p>
</td>
	<td class="code"><pre><code>	<div class="ident">feedbackRows</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewRows</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div><div class="literal">&#34;cluster_id&#34;</div><div class="operator">,</div> <div class="literal">&#34;rule_id&#34;</div><div class="operator">,</div> <div class="literal">&#34;cnt&#34;</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">feedbackRows</div><div class="operator">.</div><div class="ident">AddRow</div><div class="operator">(</div><div class="ident">cluster1ID</div><div class="operator">,</div> <div class="ident">rule1ID</div><div class="operator">,</div> <div class="literal">1</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expected query performed by tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">feedbackQuery</div> <div class="operator">:=</div> <div class="literal">&#34;select cluster_id, rule_id, count\\(\\*\\) as cnt from cluster_user_rule_disable_feedback group by cluster_id, rule_id having count\\(\\*\\)&gt;1 order by cnt desc;&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="ident">feedbackQuery</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnRows</div><div class="operator">(</div><div class="ident">feedbackRows</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare mocked org_id query result for SQL query</p>
</td>
	<td class="code"><pre><code>	<div class="ident">expectOrgIDQuery</div><div class="operator">(</div><div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectClose</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>call the tested function with invalid filename</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">DisplayMultipleRuleDisable</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="literal">&#34;/&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error not expected while calling tested function&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if DB can be closed successfully</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkConnectionClose</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">connection</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check all DB expectactions happened correctly</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkAllExpectations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestPerformListOfOldReportsNoResults checks the basic behaviour of
performListOfOldReports function.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestPerformListOfOldReportsNoResults</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare new mocked connection to database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error creating SQL mock&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare mocked result for SQL query</p>
</td>
	<td class="code"><pre><code>	<div class="ident">rows</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewRows</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expected query performed by tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">expectedQuery</div> <div class="operator">:=</div> <div class="literal">&#34;SELECT cluster, reported_at, last_checked_at FROM report WHERE reported_at &lt; NOW\\(\\) - \\$1::INTERVAL ORDER BY reported_at&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="ident">expectedQuery</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnRows</div><div class="operator">(</div><div class="ident">rows</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectClose</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>call the tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">PerformListOfOldReports</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="literal">&#34;10&#34;</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error not expected while calling tested function&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if DB can be closed successfully</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkConnectionClose</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">connection</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check all DB expectactions happened correctly</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkAllExpectations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestPerformListOfOldReportsResults checks the basic behaviour of
performListOfOldReports function.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestPerformListOfOldReportsResults</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare new mocked connection to database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error creating SQL mock&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare mocked result for SQL query</p>
</td>
	<td class="code"><pre><code>	<div class="ident">rows</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewRows</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div><div class="literal">&#34;cluster&#34;</div><div class="operator">,</div> <div class="literal">&#34;reported_at&#34;</div><div class="operator">,</div> <div class="literal">&#34;last_checked&#34;</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">reportedAt</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">updatedAt</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">rows</div><div class="operator">.</div><div class="ident">AddRow</div><div class="operator">(</div><div class="ident">cluster1ID</div><div class="operator">,</div> <div class="ident">reportedAt</div><div class="operator">,</div> <div class="ident">updatedAt</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expected query performed by tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">expectedQuery</div> <div class="operator">:=</div> <div class="literal">&#34;SELECT cluster, reported_at, last_checked_at FROM report WHERE reported_at &lt; NOW\\(\\) - \\$1::INTERVAL ORDER BY reported_at&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="ident">expectedQuery</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnRows</div><div class="operator">(</div><div class="ident">rows</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectClose</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>call the tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">PerformListOfOldReports</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="literal">&#34;10&#34;</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error not expected while calling tested function&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if DB can be closed successfully</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkConnectionClose</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">connection</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check all DB expectactions happened correctly</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkAllExpectations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestPerformListOfOldReportsScanError checks the basic behaviour of
performListOfOldReports function.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestPerformListOfOldReportsScanError</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare new mocked connection to database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error creating SQL mock&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare mocked result for SQL query</p>
</td>
	<td class="code"><pre><code>	<div class="ident">rows</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewRows</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div><div class="literal">&#34;cluster&#34;</div><div class="operator">,</div> <div class="literal">&#34;reported_at&#34;</div><div class="operator">,</div> <div class="literal">&#34;last_checked&#34;</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">reportedAt</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">updatedAt</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">rows</div><div class="operator">.</div><div class="ident">AddRow</div><div class="operator">(</div><div class="ident">nil</div><div class="operator">,</div> <div class="ident">reportedAt</div><div class="operator">,</div> <div class="ident">updatedAt</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expected query performed by tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">expectedQuery</div> <div class="operator">:=</div> <div class="literal">&#34;SELECT cluster, reported_at, last_checked_at FROM report WHERE reported_at &lt; NOW\\(\\) - \\$1::INTERVAL ORDER BY reported_at&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="ident">expectedQuery</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnRows</div><div class="operator">(</div><div class="ident">rows</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectClose</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>call the tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">PerformListOfOldReports</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="literal">&#34;10&#34;</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if DB can be closed successfully</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkConnectionClose</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">connection</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check all DB expectactions happened correctly</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkAllExpectations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestPerformListOfOldReportsDBError checks the basic behaviour of
performListOfOldReports function.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestPerformListOfOldReportsDBError</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>error to be thrown</p>
</td>
	<td class="code"><pre><code>	<div class="ident">mockedError</div> <div class="operator">:=</div> <div class="ident">errors</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="literal">&#34;mocked error&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare new mocked connection to database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error creating SQL mock&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expected query performed by tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">expectedQuery</div> <div class="operator">:=</div> <div class="literal">&#34;SELECT cluster, reported_at, last_checked_at FROM report WHERE reported_at &lt; NOW\\(\\) - \\$1::INTERVAL ORDER BY reported_at&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="ident">expectedQuery</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnError</div><div class="operator">(</div><div class="ident">mockedError</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectClose</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>call the tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">PerformListOfOldReports</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="literal">&#34;10&#34;</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">mockedError</div> <div class="operator">{</div>
		<div class="ident">t</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="literal">&#34;different error was returned: %v&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if DB can be closed successfully</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkConnectionClose</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">connection</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check all DB expectactions happened correctly</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkAllExpectations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestDisplayAllOldRecordsNoOutput checks the basic behaviour of
displayAllOldRecords function without a filename defined.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestDisplayAllOldRecordsNoOutput</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare new mocked connection to database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error creating SQL mock&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare mocked result for SQL query</p>
</td>
	<td class="code"><pre><code>	<div class="ident">rows</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewRows</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div><div class="literal">&#34;cluster&#34;</div><div class="operator">,</div> <div class="literal">&#34;reported_at&#34;</div><div class="operator">,</div> <div class="literal">&#34;last_checked&#34;</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">reportedAt</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">updatedAt</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">rows</div><div class="operator">.</div><div class="ident">AddRow</div><div class="operator">(</div><div class="ident">cluster1ID</div><div class="operator">,</div> <div class="ident">reportedAt</div><div class="operator">,</div> <div class="ident">updatedAt</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expected queries performed by tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">expectedQuery1</div> <div class="operator">:=</div> <div class="literal">&#34;SELECT cluster, reported_at, last_checked_at FROM report WHERE reported_at &lt; NOW\\(\\) - \\$1::INTERVAL ORDER BY reported_at&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="ident">expectedQuery1</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnRows</div><div class="operator">(</div><div class="ident">rows</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">expectedQuery2</div> <div class="operator">:=</div> <div class="literal">&#34;SELECT org_id, rule_fqdn, error_key, rule_id, rating, last_updated_at FROM advisor_ratings WHERE last_updated_at &lt; NOW\\(\\) - \\$1::INTERVAL ORDER BY last_updated_at&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="ident">expectedQuery2</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnRows</div><div class="operator">(</div><div class="ident">rows</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">expectedQuery3</div> <div class="operator">:=</div> <div class="literal">&#34;SELECT topic, partition, topic_offset, key, consumed_at, message FROM consumer_error WHERE consumed_at &lt; NOW\\(\\) - \\$1::INTERVAL ORDER BY consumed_at&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="ident">expectedQuery3</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnRows</div><div class="operator">(</div><div class="ident">rows</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectClose</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>call the tested function without filename (stdout)</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">DisplayAllOldRecords</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="literal">&#34;10&#34;</div><div class="operator">,</div> <div class="literal">&#34;&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error not expected while calling tested function&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if DB can be closed successfully</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkConnectionClose</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">connection</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check all DB expectactions happened correctly</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkAllExpectations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestDisplayAllOldRecordsFileOutput checks the basic behaviour of
displayAllOldRecords function without a filename defined.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestDisplayAllOldRecordsFileOutput</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">const</div> <div class="ident">outFile</div> <div class="operator">=</div> <div class="literal">&#34;testold.out&#34;</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare new mocked connection to database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error creating SQL mock&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare mocked result for SQL query</p>
</td>
	<td class="code"><pre><code>	<div class="ident">rows</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewRows</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div><div class="literal">&#34;cluster&#34;</div><div class="operator">,</div> <div class="literal">&#34;reported_at&#34;</div><div class="operator">,</div> <div class="literal">&#34;last_checked&#34;</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">reportedAt</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">updatedAt</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">rows</div><div class="operator">.</div><div class="ident">AddRow</div><div class="operator">(</div><div class="ident">cluster1ID</div><div class="operator">,</div> <div class="ident">reportedAt</div><div class="operator">,</div> <div class="ident">updatedAt</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">rows</div><div class="operator">.</div><div class="ident">AddRow</div><div class="operator">(</div><div class="ident">cluster2ID</div><div class="operator">,</div> <div class="ident">reportedAt</div><div class="operator">,</div> <div class="ident">updatedAt</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expected queries performed by tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">expectedQuery1</div> <div class="operator">:=</div> <div class="literal">&#34;SELECT cluster, reported_at, last_checked_at FROM report WHERE reported_at &lt; NOW\\(\\) - \\$1::INTERVAL ORDER BY reported_at&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="ident">expectedQuery1</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnRows</div><div class="operator">(</div><div class="ident">rows</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">expectedQuery2</div> <div class="operator">:=</div> <div class="literal">&#34;SELECT org_id, rule_fqdn, error_key, rule_id, rating, last_updated_at FROM advisor_ratings WHERE last_updated_at &lt; NOW\\(\\) - \\$1::INTERVAL ORDER BY last_updated_at&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="ident">expectedQuery2</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnRows</div><div class="operator">(</div><div class="ident">rows</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">expectedQuery3</div> <div class="operator">:=</div> <div class="literal">&#34;SELECT topic, partition, topic_offset, key, consumed_at, message FROM consumer_error WHERE consumed_at &lt; NOW\\(\\) - \\$1::INTERVAL ORDER BY consumed_at&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="ident">expectedQuery3</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnRows</div><div class="operator">(</div><div class="ident">rows</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectClose</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>call the tested function without filename (stdout)</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">DisplayAllOldRecords</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="literal">&#34;10&#34;</div><div class="operator">,</div> <div class="ident">outFile</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error not expected while calling tested function&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if DB can be closed successfully</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkConnectionClose</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">connection</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check all DB expectactions happened correctly</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkAllExpectations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check contents of the output file</p>
</td>
	<td class="code"><pre><code>	<div class="ident">outputFile</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">os</div><div class="operator">.</div><div class="ident">Open</div><div class="operator">(</div><div class="ident">outFile</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">scanner</div> <div class="operator">:=</div> <div class="ident">bufio</div><div class="operator">.</div><div class="ident">NewScanner</div><div class="operator">(</div><div class="ident">outputFile</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">var</div> <div class="ident">lines</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator"></div>
	<div class="keyword">for</div> <div class="ident">scanner</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="ident">lines</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">lines</div><div class="operator">,</div> <div class="ident">scanner</div><div class="operator">.</div><div class="ident">Text</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>two lines must be in the file</p>
</td>
	<td class="code"><pre><code>	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Len</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">lines</div><div class="operator">,</div> <div class="literal">2</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>4 comma separated values</p>
</td>
	<td class="code"><pre><code>	<div class="ident">line1</div> <div class="operator">:=</div> <div class="ident">strings</div><div class="operator">.</div><div class="ident">Split</div><div class="operator">(</div><div class="ident">lines</div><div class="operator">[</div><div class="literal">0</div><div class="operator">]</div><div class="operator">,</div> <div class="literal">&#34;,&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Len</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">line1</div><div class="operator">,</div> <div class="literal">4</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check elements in csv</p>
</td>
	<td class="code"><pre><code>	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">line1</div><div class="operator">[</div><div class="literal">0</div><div class="operator">]</div><div class="operator">,</div> <div class="ident">cluster1ID</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">line1</div><div class="operator">[</div><div class="literal">1</div><div class="operator">]</div><div class="operator">,</div> <div class="ident">reportedAt</div><div class="operator">.</div><div class="ident">Format</div><div class="operator">(</div><div class="ident">time</div><div class="operator">.</div><div class="ident">RFC3339</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">line1</div><div class="operator">[</div><div class="literal">2</div><div class="operator">]</div><div class="operator">,</div> <div class="ident">updatedAt</div><div class="operator">.</div><div class="ident">Format</div><div class="operator">(</div><div class="ident">time</div><div class="operator">.</div><div class="ident">RFC3339</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">line1</div><div class="operator">[</div><div class="literal">3</div><div class="operator">]</div><div class="operator">,</div> <div class="literal">&#34;1&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">line2</div> <div class="operator">:=</div> <div class="ident">strings</div><div class="operator">.</div><div class="ident">Split</div><div class="operator">(</div><div class="ident">lines</div><div class="operator">[</div><div class="literal">1</div><div class="operator">]</div><div class="operator">,</div> <div class="literal">&#34;,&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">line2</div><div class="operator">[</div><div class="literal">0</div><div class="operator">]</div><div class="operator">,</div> <div class="ident">cluster2ID</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">line2</div><div class="operator">[</div><div class="literal">1</div><div class="operator">]</div><div class="operator">,</div> <div class="ident">reportedAt</div><div class="operator">.</div><div class="ident">Format</div><div class="operator">(</div><div class="ident">time</div><div class="operator">.</div><div class="ident">RFC3339</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">line2</div><div class="operator">[</div><div class="literal">2</div><div class="operator">]</div><div class="operator">,</div> <div class="ident">updatedAt</div><div class="operator">.</div><div class="ident">Format</div><div class="operator">(</div><div class="ident">time</div><div class="operator">.</div><div class="ident">RFC3339</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">line2</div><div class="operator">[</div><div class="literal">3</div><div class="operator">]</div><div class="operator">,</div> <div class="literal">&#34;1&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">outputFile</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>delete test file from filesystem</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">os</div><div class="operator">.</div><div class="ident">Remove</div><div class="operator">(</div><div class="ident">outFile</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestDisplayAllOldRecordsWithFileError checks the basic behaviour of
displayAllOldRecords function with file error</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestDisplayAllOldRecordsWithFileError</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare new mocked connection to database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error creating SQL mock&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare mocked result for SQL query</p>
</td>
	<td class="code"><pre><code>	<div class="ident">rows</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewRows</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div><div class="literal">&#34;cluster&#34;</div><div class="operator">,</div> <div class="literal">&#34;reported_at&#34;</div><div class="operator">,</div> <div class="literal">&#34;last_checked&#34;</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">reportedAt</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">updatedAt</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">rows</div><div class="operator">.</div><div class="ident">AddRow</div><div class="operator">(</div><div class="ident">cluster1ID</div><div class="operator">,</div> <div class="ident">reportedAt</div><div class="operator">,</div> <div class="ident">updatedAt</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expected queries performed by tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">expectedQuery1</div> <div class="operator">:=</div> <div class="literal">&#34;SELECT cluster, reported_at, last_checked_at FROM report WHERE reported_at &lt; NOW\\(\\) - \\$1::INTERVAL ORDER BY reported_at&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="ident">expectedQuery1</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnRows</div><div class="operator">(</div><div class="ident">rows</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">expectedQuery2</div> <div class="operator">:=</div> <div class="literal">&#34;SELECT org_id, rule_fqdn, error_key, rule_id, rating, last_updated_at FROM advisor_ratings WHERE last_updated_at &lt; NOW\\(\\) - \\$1::INTERVAL ORDER BY last_updated_at&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="ident">expectedQuery2</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnRows</div><div class="operator">(</div><div class="ident">rows</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">expectedQuery3</div> <div class="operator">:=</div> <div class="literal">&#34;SELECT topic, partition, topic_offset, key, consumed_at, message FROM consumer_error WHERE consumed_at &lt; NOW\\(\\) - \\$1::INTERVAL ORDER BY consumed_at&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="ident">expectedQuery3</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnRows</div><div class="operator">(</div><div class="ident">rows</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectClose</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>call the tested function with invalid filename (&quot;/&quot;)</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">DisplayAllOldRecords</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="literal">&#34;10&#34;</div><div class="operator">,</div> <div class="literal">&#34;/&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error not expected while calling tested function&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if DB can be closed successfully</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkConnectionClose</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">connection</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check all DB expectactions happened correctly</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkAllExpectations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestDisplayAllOldRecordsNoConnection checks the basic behaviour of
displayAllOldRecords function when connection is not established</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestDisplayAllOldRecordsNoConnection</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>call the tested function with invalid filename (&quot;/&quot;)</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">DisplayAllOldRecords</div><div class="operator">(</div><div class="ident">nil</div><div class="operator">,</div> <div class="literal">&#34;10&#34;</div><div class="operator">,</div> <div class="literal">&#34;/&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error is expected while calling tested function&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestPerformListOfOldReportsOnError checks the error handling
ability in performListOfOldReports function.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestPerformListOfOldReportsOnError</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>error to be thrown</p>
</td>
	<td class="code"><pre><code>	<div class="ident">mockedError</div> <div class="operator">:=</div> <div class="ident">errors</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="literal">&#34;mocked error&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare new mocked connection to database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error creating SQL mock&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expected query performed by tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">expectedQuery</div> <div class="operator">:=</div> <div class="literal">&#34;SELECT cluster, reported_at, last_checked_at FROM report WHERE reported_at &lt; NOW\\(\\) - \\$1::INTERVAL ORDER BY reported_at&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="ident">expectedQuery</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnError</div><div class="operator">(</div><div class="ident">mockedError</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectClose</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>call the tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">PerformListOfOldReports</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="literal">&#34;10&#34;</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">==</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">t</div><div class="operator">.</div><div class="ident">Fatalf</div><div class="operator">(</div><div class="literal">&#34;error was expected while updating stats&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if the error is correct</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">mockedError</div> <div class="operator">{</div>
		<div class="ident">t</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="literal">&#34;different error was returned: %v&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if DB can be closed successfully</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkConnectionClose</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">connection</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check all DB expectactions happened correctly</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkAllExpectations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestDeleteRecordFromTable checks the basic behaviour of
deleteRecordFromTable function.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestDeleteRecordFromTable</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare new mocked connection to database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error creating SQL mock&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expected query performed by tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">expectedExec</div> <div class="operator">:=</div> <div class="literal">&#34;DELETE FROM table_x WHERE key_x = \\$&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectExec</div><div class="operator">(</div><div class="ident">expectedExec</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WithArgs</div><div class="operator">(</div><div class="literal">&#34;key_value&#34;</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnResult</div><div class="operator">(</div><div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewResult</div><div class="operator">(</div><div class="literal">1</div><div class="operator">,</div> <div class="literal">1</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectClose</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>call the tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">affected</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">DeleteRecordFromTable</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="literal">&#34;table_x&#34;</div><div class="operator">,</div> <div class="literal">&#34;key_x&#34;</div><div class="operator">,</div> <div class="literal">&#34;key_value&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error not expected while calling tested function&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>test number of affected rows</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="ident">affected</div> <div class="operator">!=</div> <div class="literal">1</div> <div class="operator">{</div>
		<div class="ident">t</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="literal">&#34;wrong number of rows affected: %d&#34;</div><div class="operator">,</div> <div class="ident">affected</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if DB can be closed successfully</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkConnectionClose</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">connection</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check all DB expectactions happened correctly</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkAllExpectations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestDeleteRecordFromTableOnError checks the error handling in
deleteRecordFromTable function.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestDeleteRecordFromTableOnError</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>error to be thrown</p>
</td>
	<td class="code"><pre><code>	<div class="ident">mockedError</div> <div class="operator">:=</div> <div class="ident">errors</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="literal">&#34;mocked error&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare new mocked connection to database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error creating SQL mock&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expected query performed by tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">expectedExec</div> <div class="operator">:=</div> <div class="literal">&#34;DELETE FROM table_x WHERE key_x = \\$&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectExec</div><div class="operator">(</div><div class="ident">expectedExec</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WithArgs</div><div class="operator">(</div><div class="literal">&#34;key_value&#34;</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnError</div><div class="operator">(</div><div class="ident">mockedError</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectClose</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>call the tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">affected</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">DeleteRecordFromTable</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="literal">&#34;table_x&#34;</div><div class="operator">,</div> <div class="literal">&#34;key_x&#34;</div><div class="operator">,</div> <div class="literal">&#34;key_value&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">==</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">t</div><div class="operator">.</div><div class="ident">Fatalf</div><div class="operator">(</div><div class="literal">&#34;error was expected while updating stats&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>test number of affected rows</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="ident">affected</div> <div class="operator">!=</div> <div class="literal">0</div> <div class="operator">{</div>
		<div class="ident">t</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="literal">&#34;wrong number of rows affected: %d&#34;</div><div class="operator">,</div> <div class="ident">affected</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if the error is correct</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">mockedError</div> <div class="operator">{</div>
		<div class="ident">t</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="literal">&#34;different error was returned: %v&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if DB can be closed successfully</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkConnectionClose</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">connection</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check all DB expectactions happened correctly</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkAllExpectations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestPerformVacuumDB checks the basic behaviour of
PerformVacuumDB function.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestPerformVacuumDB</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare new mocked connection to database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error creating SQL mock&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expected query performed by tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">expectedExec</div> <div class="operator">:=</div> <div class="literal">&#34;DELETE FROM table_x WHERE key_x = \\$&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectExec</div><div class="operator">(</div><div class="ident">expectedExec</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WithArgs</div><div class="operator">(</div><div class="literal">&#34;key_value&#34;</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnResult</div><div class="operator">(</div><div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewResult</div><div class="operator">(</div><div class="literal">1</div><div class="operator">,</div> <div class="literal">1</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">expectedVacuum</div> <div class="operator">:=</div> <div class="literal">&#34;VACUUM VERBOSE;&#34;</div><div class="operator"></div>
	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectExec</div><div class="operator">(</div><div class="ident">expectedVacuum</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnResult</div><div class="operator">(</div><div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewResult</div><div class="operator">(</div><div class="literal">1</div><div class="operator">,</div> <div class="literal">1</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectClose</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>call the tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">affected</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">DeleteRecordFromTable</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="literal">&#34;table_x&#34;</div><div class="operator">,</div> <div class="literal">&#34;key_x&#34;</div><div class="operator">,</div> <div class="literal">&#34;key_value&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error not expected while calling tested function&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>test number of affected rows</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="ident">affected</div> <div class="operator">!=</div> <div class="literal">1</div> <div class="operator">{</div>
		<div class="ident">t</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="literal">&#34;wrong number of rows affected: %d&#34;</div><div class="operator">,</div> <div class="ident">affected</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">PerformVacuumDB</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error not expected while calling tested function&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if DB can be closed successfully</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkConnectionClose</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">connection</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check all DB expectactions happened correctly</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkAllExpectations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestFillInDatabaseByTestData checks the basic behaviour of
fillInDatabaseByTestData function.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestFillInDatabaseByTestData</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare new mocked connection to database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error creating SQL mock&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">clusterNames</div> <div class="operator">:=</div> <div class="operator">[</div><div class="operator">...</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div>
		<div class="literal">&#34;00000000-0000-0000-0000-000000000000&#34;</div><div class="operator">,</div>
		<div class="literal">&#34;11111111-1111-1111-1111-111111111111&#34;</div><div class="operator">,</div>
		<div class="literal">&#34;5d5892d4-1f74-4ccf-91af-548dfc9767aa&#34;</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">clusterName</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">clusterNames</div> <div class="operator">{</div>
		<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectExec</div><div class="operator">(</div><div class="literal">&#34;INSERT INTO report&#34;</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WithArgs</div><div class="operator">(</div><div class="ident">clusterName</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnResult</div><div class="operator">(</div><div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewResult</div><div class="operator">(</div><div class="literal">1</div><div class="operator">,</div> <div class="literal">1</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectExec</div><div class="operator">(</div><div class="literal">&#34;INSERT INTO cluster_rule_toggle&#34;</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WithArgs</div><div class="operator">(</div><div class="ident">clusterName</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnResult</div><div class="operator">(</div><div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewResult</div><div class="operator">(</div><div class="literal">1</div><div class="operator">,</div> <div class="literal">1</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectExec</div><div class="operator">(</div><div class="literal">&#34;INSERT INTO cluster_rule_user_feedback&#34;</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WithArgs</div><div class="operator">(</div><div class="ident">clusterName</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnResult</div><div class="operator">(</div><div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewResult</div><div class="operator">(</div><div class="literal">1</div><div class="operator">,</div> <div class="literal">1</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectExec</div><div class="operator">(</div><div class="literal">&#34;INSERT INTO cluster_user_rule_disable_feedback&#34;</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WithArgs</div><div class="operator">(</div><div class="ident">clusterName</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnResult</div><div class="operator">(</div><div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewResult</div><div class="operator">(</div><div class="literal">1</div><div class="operator">,</div> <div class="literal">1</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectExec</div><div class="operator">(</div><div class="literal">&#34;INSERT INTO rule_hit&#34;</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WithArgs</div><div class="operator">(</div><div class="ident">clusterName</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnResult</div><div class="operator">(</div><div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewResult</div><div class="operator">(</div><div class="literal">1</div><div class="operator">,</div> <div class="literal">1</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectClose</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">FillInDatabaseByTestData</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error not expected while calling tested function&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if DB can be closed successfully</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkConnectionClose</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">connection</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check all DB expectactions happened correctly</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkAllExpectations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestPerformCleanupInDB checks the basic behaviour of
performCleanupInDB function.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestPerformCleanupInDB</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">expectedResult</div> <div class="operator">:=</div> <div class="ident">make</div><div class="operator">(</div><div class="keyword">map</div><div class="operator">[</div><div class="ident">string</div><div class="operator">]</div><div class="ident">int</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare new mocked connection to database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error creating SQL mock&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">clusterNames</div> <div class="operator">:=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">ClusterList</div><div class="operator">{</div>
		<div class="literal">&#34;00000000-0000-0000-0000-000000000000&#34;</div><div class="operator">,</div>
		<div class="literal">&#34;11111111-1111-1111-1111-111111111111&#34;</div><div class="operator">,</div>
		<div class="literal">&#34;5d5892d4-1f74-4ccf-91af-548dfc9767aa&#34;</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">clusterName</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">clusterNames</div> <div class="operator">{</div>
		<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">tableAndKey</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">TablesAndKeys</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expected query performed by tested function</p>
</td>
	<td class="code"><pre><code>			<div class="ident">expectedExec</div> <div class="operator">:=</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Sprintf</div><div class="operator">(</div><div class="literal">&#34;DELETE FROM %v WHERE %v = \\$&#34;</div><div class="operator">,</div> <div class="ident">tableAndKey</div><div class="operator">.</div><div class="ident">TableName</div><div class="operator">,</div> <div class="ident">tableAndKey</div><div class="operator">.</div><div class="ident">KeyName</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectExec</div><div class="operator">(</div><div class="ident">expectedExec</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WithArgs</div><div class="operator">(</div><div class="ident">clusterName</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnResult</div><div class="operator">(</div><div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewResult</div><div class="operator">(</div><div class="literal">1</div><div class="operator">,</div> <div class="literal">2</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>two deleted rows for each cluster</p>
</td>
	<td class="code"><pre><code>			<div class="ident">expectedResult</div><div class="operator">[</div><div class="ident">tableAndKey</div><div class="operator">.</div><div class="ident">TableName</div><div class="operator">]</div> <div class="operator">&#43;=</div> <div class="literal">2</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectClose</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">deletedRows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">PerformCleanupInDB</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="ident">clusterNames</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error not expected while calling tested function&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check tables have correct number of deleted rows for each table</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">for</div> <div class="ident">tableName</div><div class="operator">,</div> <div class="ident">deletedRowCount</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">deletedRows</div> <div class="operator">{</div>
		<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">expectedResult</div><div class="operator">[</div><div class="ident">tableName</div><div class="operator">]</div><div class="operator">,</div> <div class="ident">deletedRowCount</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if DB can be closed successfully</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkConnectionClose</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">connection</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check all DB expectactions happened correctly</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkAllExpectations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestPerformCleanupInDBOnDeleteError checks the basic behaviour of
performCleanupInDB function when error in called DeleteRecordFromTable.
is thrown</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestPerformCleanupInDBOnDeleteError</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>error to be thrown</p>
</td>
	<td class="code"><pre><code>	<div class="ident">mockedError</div> <div class="operator">:=</div> <div class="ident">errors</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="literal">&#34;delete from table&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">expectedResult</div> <div class="operator">:=</div> <div class="ident">make</div><div class="operator">(</div><div class="keyword">map</div><div class="operator">[</div><div class="ident">string</div><div class="operator">]</div><div class="ident">int</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare new mocked connection to database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error creating SQL mock&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">clusterNames</div> <div class="operator">:=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">ClusterList</div><div class="operator">{</div>
		<div class="literal">&#34;00000000-0000-0000-0000-000000000000&#34;</div><div class="operator">,</div>
		<div class="literal">&#34;11111111-1111-1111-1111-111111111111&#34;</div><div class="operator">,</div>
		<div class="literal">&#34;5d5892d4-1f74-4ccf-91af-548dfc9767aa&#34;</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">clusterName</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">clusterNames</div> <div class="operator">{</div>
		<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">tableAndKey</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">TablesAndKeys</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expected query performed by tested function</p>
</td>
	<td class="code"><pre><code>			<div class="ident">expectedExec</div> <div class="operator">:=</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Sprintf</div><div class="operator">(</div><div class="literal">&#34;DELETE FROM %v WHERE %v = \\$&#34;</div><div class="operator">,</div> <div class="ident">tableAndKey</div><div class="operator">.</div><div class="ident">TableName</div><div class="operator">,</div> <div class="ident">tableAndKey</div><div class="operator">.</div><div class="ident">KeyName</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectExec</div><div class="operator">(</div><div class="ident">expectedExec</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WithArgs</div><div class="operator">(</div><div class="ident">clusterName</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnError</div><div class="operator">(</div><div class="ident">mockedError</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>NO deleted rows for any cluster</p>
</td>
	<td class="code"><pre><code>			<div class="ident">expectedResult</div><div class="operator">[</div><div class="ident">tableAndKey</div><div class="operator">.</div><div class="ident">TableName</div><div class="operator">]</div> <div class="operator">=</div> <div class="literal">0</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">mock</div><div class="operator">.</div><div class="ident">ExpectClose</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">deletedRows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">PerformCleanupInDB</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="ident">clusterNames</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error not expected while calling tested function&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check tables have correct number of deleted rows for each table</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">for</div> <div class="ident">tableName</div><div class="operator">,</div> <div class="ident">deletedRowCount</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">deletedRows</div> <div class="operator">{</div>
		<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">expectedResult</div><div class="operator">[</div><div class="ident">tableName</div><div class="operator">]</div><div class="operator">,</div> <div class="ident">deletedRowCount</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if DB can be closed successfully</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkConnectionClose</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">connection</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check all DB expectactions happened correctly</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkAllExpectations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mock</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestPerformCleanupInDBNoConnection checks the basic behaviour of
performCleanupInDB function when connection is not established.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestPerformCleanupInDBNoConnection</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>connection that is not constructed correctly</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">var</div> <div class="ident">connection</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div> <div class="operator">=</div> <div class="ident">nil</div><div class="operator"></div>

	<div class="ident">clusterNames</div> <div class="operator">:=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">ClusterList</div><div class="operator">{</div>
		<div class="literal">&#34;00000000-0000-0000-0000-000000000000&#34;</div><div class="operator">,</div>
		<div class="literal">&#34;11111111-1111-1111-1111-111111111111&#34;</div><div class="operator">,</div>
		<div class="literal">&#34;5d5892d4-1f74-4ccf-91af-548dfc9767aa&#34;</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">PerformCleanupInDB</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="ident">clusterNames</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error is expected while calling tested function&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestInitDatabaseNoConfiguration checks how initDatabaseConnection function
behave if null configuration is used</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestInitDatabaseNoConfiguration</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>not initialized storage configuration</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">var</div> <div class="ident">configurationPtr</div> <div class="operator">*</div><div class="ident">cleaner</div><div class="operator">.</div><div class="ident">StorageConfiguration</div> <div class="operator">=</div> <div class="ident">nil</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>call tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">InitDatabaseConnection</div><div class="operator">(</div><div class="ident">configurationPtr</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check output from tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error is expected while calling tested function&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Nil</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">connection</div><div class="operator">,</div> <div class="literal">&#34;connection should not be established&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestInitDatabaseWrongDriver checks how initDatabaseConnection function
behave if configuration with wrong driver is used</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestInitDatabaseWrongDriver</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>not initialized storage configuration</p>
</td>
	<td class="code"><pre><code>	<div class="ident">configuration</div> <div class="operator">:=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">StorageConfiguration</div><div class="operator">{</div>
		<div class="ident">Driver</div><div class="operator">:</div> <div class="literal">&#34;wrong-one&#34;</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>call tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">InitDatabaseConnection</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">configuration</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check output from tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error is expected while calling tested function&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Nil</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">connection</div><div class="operator">,</div> <div class="literal">&#34;connection should not be established&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestInitDatabaseSQLite3Driver driver checks how initDatabaseConnection function
behave if configuration with SQLite3 driver is used</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestInitDatabaseSQLite3Driver</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>properly initialized storage configuration for SQLite3</p>
</td>
	<td class="code"><pre><code>	<div class="ident">configuration</div> <div class="operator">:=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">StorageConfiguration</div><div class="operator">{</div>
		<div class="ident">Driver</div><div class="operator">:</div>           <div class="literal">&#34;sqlite3&#34;</div><div class="operator">,</div>
		<div class="ident">SQLiteDataSource</div><div class="operator">:</div> <div class="literal">&#34;/tmp/test.db&#34;</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>call tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">InitDatabaseConnection</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">configuration</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check output from tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error is not expected while calling tested function&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NotNil</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">connection</div><div class="operator">,</div> <div class="literal">&#34;connection should be established&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestInitDatabasePostgreSQLDriver driver checks how initDatabaseConnection function
behave if configuration with PostgreSQL driver is used</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestInitDatabasePostgreSQLDriver</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>properly initialized storage configuration for PostgreSQL</p>
</td>
	<td class="code"><pre><code>	<div class="ident">configuration</div> <div class="operator">:=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">StorageConfiguration</div><div class="operator">{</div>
		<div class="ident">Driver</div><div class="operator">:</div>     <div class="literal">&#34;postgres&#34;</div><div class="operator">,</div>
		<div class="ident">PGUsername</div><div class="operator">:</div> <div class="literal">&#34;user&#34;</div><div class="operator">,</div>
		<div class="ident">PGPassword</div><div class="operator">:</div> <div class="literal">&#34;password&#34;</div><div class="operator">,</div>
		<div class="ident">PGHost</div><div class="operator">:</div>     <div class="literal">&#34;nowhere&#34;</div><div class="operator">,</div>
		<div class="ident">PGPort</div><div class="operator">:</div>     <div class="literal">1234</div><div class="operator">,</div>
		<div class="ident">PGDBName</div><div class="operator">:</div>   <div class="literal">&#34;test&#34;</div><div class="operator">,</div>
		<div class="ident">PGParams</div><div class="operator">:</div>   <div class="literal">&#34;&#34;</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>call tested function
(open may just validate its arguments without creating a connection to the database)</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">cleaner</div><div class="operator">.</div><div class="ident">InitDatabaseConnection</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">configuration</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check output from tested function</p>
</td>
	<td class="code"><pre><code>	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;error is not expected while calling tested function&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NotNil</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">connection</div><div class="operator">,</div> <div class="literal">&#34;connection should be established&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
    </tbody>
  </table>
</div>
</body>
</html>
